{% extends 'base.html' %}
{% load staticfiles %}
{% load bootstrap_tags %}
{% block content %}
    <h1>Edit your account</h1>

    <hr>

    <h2>Your avatar</h2>

    <input type="file" id="file-input">
    <p id="status">Please select a file</p>
    <img style="border:1px solid gray;width:300px;" id="preview" src="/static/media/default.png">

    <h2>Your information</h2>

    <form method="POST" action="/accounts/submit_form/">
      <input type="hidden" id="avatar-url" name="avatar-url" value="/static/media/default.png">
      <input type="text" name="username" placeholder="Username"><br>
      <input type="text" name="full-name" placeholder="Full name"><br><br>

      <hr>
      <h2>Save changes</h2>

      <input type="submit" value="Update profile">
    </form>
{% endblock %}
{% block script %}
    <script>
        (function() {
            console.log('PAGE LOADED');
            /**
             * This function accepts the file to be uploaded,
             * the S3 request data,
             * and the URL representing the eventual location of the avatar image.
             */
            function uploadFile(file, s3Data, url){
                var xhr = new XMLHttpRequest();
                xhr.open("POST", s3Data.url);

                var postData = new FormData();
                for(key in s3Data.fields){
                    postData.append(key, s3Data.fields[key]);
                }
                postData.append('file', file);
                console.log('UPLOADING THE FILE')
                xhr.onreadystatechange = function() {
                    if(xhr.readyState === 4){
                        if(xhr.status === 200 || xhr.status === 204){
                            console.log('SUCCESS SO FAR')
                            document.getElementById("preview").src = url;
                            document.getElementById("avatar-url").value = url;
                        }
                        else{
                        alert("Could not upload file.");
                        }
                    }
                };
                xhr.send(postData);
}

            /**
             * Function accepts the UPLOADED file object and retrieves a signed POST request from S3
             */
            function getSignedRequest(file){
                var xhr = new XMLHttpRequest();
                    //  function passes the file name and type and params to the GET request
                    xhr.open("GET", "/accounts/sign_s3?file_name="+file.name+"&file_type="+file.type);
                    xhr.onreadystatechange = function(){
                        if(xhr.readyState === 4){
                            //  if successful the function continues by calling a function to upload the actual file to S3
                            if(xhr.status === 200){
                                var response = JSON.parse(xhr.responseText);
                                console.log('POST REQUEST SUCCESSFUL');
                                console.log('Response URL is '+response.url)
                                uploadFile(file, response.data, response.url);
                            }
                            else{
                                alert("Could not get signed URL.");
                            }
                        }
                    }
            };

            /**
             * Listen for changes to the element file-input
             */
            document.getElementById("file-input").onchange = function(){
                var files = document.getElementById("file-input").files;
                var file = files[0];
                if(!file){
                    return alert("No file selected.");032
                }
                getSignedRequest(file);
            };
        })();
    </script>
{% endblock %}
